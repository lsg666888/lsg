
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>ğŸ® LSG å¥–åŠ±ç³»ç»Ÿ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      background: linear-gradient(to bottom, #fffbe6, #fce4ec);
      padding: 20px;
    }
    .card {
      max-width: 500px;
      margin: auto;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: center;
    }
    h2 {
      margin-top: 0;
      font-size: 24px;
      color: #ff4081;
    }
    button {
      background-color: #ff4081;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      margin: 8px 0;
      font-size: 16px;
      width: 100%;
      cursor: pointer;
    }
    button:hover {
      background-color: #e91e63;
    }
    .info p {
      margin: 8px 0;
      font-size: 14px;
      color: #444;
    }
    a {
      color: #007bff;
      word-break: break-all;
    }
    .footer {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>LSG é“¾æ¸¸å¥–åŠ±ç³»ç»Ÿ</h2>
    <button onclick="connectWallet()">ğŸ”Œ è¿æ¥é’±åŒ…</button>
    <div class="info">
      <p>é’±åŒ…åœ°å€: <span id="userAddress">æœªè¿æ¥</span></p>
      <p>LSG ä½™é¢: <span id="balance">-</span></p>
      <p>æ³¨å†ŒçŠ¶æ€: <span id="registerStatus">æœªçŸ¥</span></p>
    </div>
    <button onclick="register()">ğŸ æ³¨å†Œé¢†å– 10 LSG</button>
    <button onclick="claimDaily()">ğŸ“… æ¯æ—¥ç­¾åˆ° é¢†å– 1 LSG</button>
    <p>æˆ‘çš„é‚€è¯·é“¾æ¥:</p>
    <a id="inviteLink" href="#">ç”Ÿæˆä¸­...</a>
    <div class="footer">Powered by LSG on CFX eSpace</div>
  </div>

  <script>
    const rewardContractAddress = "0xe7a2f227174066eba05ea551e12a3a02d308105b";
    const lsgTokenAddress = "0xc926c05eac192418a3a29e41c38197dffcd9b4ab";
    const rewardAbiUrl = "LSGRewardDistributor_ABI.json";

    let provider, signer, userAddress;
    let rewardContract, lsgContract;

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert("è¯·ä½¿ç”¨æ”¯æŒé’±åŒ…çš„æµè§ˆå™¨ï¼Œå¦‚ TPã€Fluent æˆ– MetaMaskã€‚");
        return;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("userAddress").innerText = userAddress;

        const abi = await fetch(rewardAbiUrl).then(res => res.json());
        rewardContract = new ethers.Contract(rewardContractAddress, abi, signer);

        const erc20Abi = [{
          constant: true,
          inputs: [{ name: "_owner", type: "address" }],
          name: "balanceOf",
          outputs: [{ name: "balance", type: "uint256" }],
          type: "function"
        }];
        lsgContract = new ethers.Contract(lsgTokenAddress, erc20Abi, provider);

        await updateInfo();
        generateInviteLink();
      } catch (e) {
        alert("è¿æ¥é’±åŒ…å¤±è´¥: " + e.message);
        console.error(e);
      }
    }

    async function updateInfo() {
      try {
        const balance = await lsgContract.balanceOf(userAddress);
        document.getElementById("balance").innerText = ethers.utils.formatUnits(balance, 18);

        const info = await rewardContract.getInfo(userAddress);
        document.getElementById("registerStatus").innerText = info[0] ? "âœ… å·²æ³¨å†Œ" : "âŒ æœªæ³¨å†Œ";
      } catch (e) {
        document.getElementById("registerStatus").innerText = "è¯»å–å¤±è´¥";
        console.error("getInfoå¤±è´¥", e);
      }
    }

    async function register() {
      try {
        const inviter = new URLSearchParams(window.location.search).get("inviter") || ethers.constants.AddressZero;
        const tx = await rewardContract.register(inviter);
        await tx.wait();
        alert("æ³¨å†ŒæˆåŠŸï¼Œå¥–åŠ±å·²å‘æ”¾ï¼");
        await updateInfo();
      } catch (e) {
        alert("æ³¨å†Œå¤±è´¥: " + e.message);
        console.error(e);
      }
    }

    async function claimDaily() {
      try {
        const tx = await rewardContract.claimDailyReward();
        await tx.wait();
        alert("æ¯æ—¥ç­¾åˆ°æˆåŠŸï¼");
        await updateInfo();
      } catch (e) {
        alert("é¢†å–å¤±è´¥: " + e.message);
        console.error(e);
      }
    }

    function generateInviteLink() {
      const base = window.location.origin + window.location.pathname;
      const link = `${base}?inviter=${userAddress}`;
      const a = document.getElementById("inviteLink");
      a.href = link;
      a.innerText = link;
    }
  </script>
</body>
</html>
