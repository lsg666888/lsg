<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å…»ç‰›é“¾æ¸¸ - LSG å¥–åŠ±ç³»ç»Ÿ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    button { padding: 10px 20px; margin: 5px 0; font-size: 16px; }
    .info { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ® LSG å¥–åŠ±ç³»ç»Ÿ</h2>
    <button onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    <div class="info">
      <p>åœ°å€: <span id="userAddress">æœªè¿æ¥</span></p>
      <p>LSG ä½™é¢: <span id="balance">-</span></p>
      <p>æ³¨å†ŒçŠ¶æ€: <span id="registerStatus">-</span></p>
    </div>
    <button onclick="register()">æ³¨å†Œï¼ˆé€10 LSGï¼‰</button>
    <button onclick="claimDaily()">æ¯æ—¥ç­¾åˆ°ï¼ˆé¢†1 LSGï¼‰</button>
    <p>é‚€è¯·é“¾æ¥: <a id="inviteLink" href="#">ç”Ÿæˆä¸­...</a></p>
  </div>

  <script>
    const rewardContractAddress = "0xe7a2f227174066eba05ea551e12a3a02d308105b";
    const lsgTokenAddress = "0xc926c05eac192418a3a29e41c38197dffcd9b4ab";
    const rewardAbiUrl = "LSGRewardDistributor_ABI.json";

    let provider, signer, userAddress;
    let rewardContract, lsgContract;

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum, "any");
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          document.getElementById("userAddress").innerText = userAddress;

          await initContracts(signer, provider);
          await updateInfo();
          generateInviteLink();
        } catch (error) {
          alert("è¿æ¥é’±åŒ…å¤±è´¥: " + error.message);
          console.error(error);
        }
      } else {
        alert("è¯·å®‰è£… TPã€Fluent æˆ– MetaMask é’±åŒ…æ’ä»¶ï¼");
      }
    }

    async function initContracts(signer, provider) {
      const abi = await fetch(rewardAbiUrl).then(res => res.json());
      rewardContract = new ethers.Contract(rewardContractAddress, abi, signer);

      const erc20Abi = [{constant:true,inputs:[{name:"_owner",type:"address"}],name:"balanceOf",outputs:[{name:"balance",type:"uint256"}],type:"function"}];
      lsgContract = new ethers.Contract(lsgTokenAddress, erc20Abi, provider);
    }

    async function updateInfo() {
      const balance = await lsgContract.balanceOf(userAddress);
      document.getElementById("balance").innerText = ethers.utils.formatUnits(balance, 18);

      const info = await rewardContract.getInfo(userAddress);
      document.getElementById("registerStatus").innerText = info.isRegistered ? "å·²æ³¨å†Œ" : "æœªæ³¨å†Œ";
    }

    async function register() {
      const inviter = new URLSearchParams(window.location.search).get("inviter") || ethers.constants.AddressZero;
      try {
        await (await rewardContract.register(inviter)).wait();
        alert("æ³¨å†ŒæˆåŠŸï¼Œå·²å‘æ”¾ 10 LSGï¼");
        updateInfo();
      } catch (err) {
        alert("æ³¨å†Œå¤±è´¥ï¼š" + err.message);
      }
    }

    async function claimDaily() {
      try {
        await (await rewardContract.claimDailyReward()).wait();
        alert("ç­¾åˆ°æˆåŠŸï¼Œå¾—åˆ° 1 LSGï¼");
        updateInfo();
      } catch (err) {
        alert("ç­¾åˆ°å¤±è´¥ï¼š" + err.message);
      }
    }

    function generateInviteLink() {
      const base = window.location.origin + window.location.pathname;
      const link = `${base}?inviter=${userAddress}`;
      const a = document.getElementById("inviteLink");
      a.href = link;
      a.innerText = link;
    }
  </script>
</body>
</html>
